# Brex Snowflake Table Definitions
# Core tables and their business context

primary_tables:
  customer_wide:
    full_name: "coredata.customer.customer_wide"
    purpose: "Master customer table with profile and segment data"
    primary_key: "customer_account_id"
    key_fields:
      - customer_account_id: "Unique customer identifier"
      - dba_name: "Customer business name"
      - empower_edition: "SaaS edition (Premium, Enterprise, Essentials)"
      - one_brex_segment: "Finance segmentation (Early Stage, Growth, MM, Enterprise)"
      - employee_count: "Customer company size"
      - cohort_start_date: "Customer acquisition date"
      - status: "Customer status (active, inactive, etc.)"
      - internal_account_type: "Account type (customer_account for real customers)"
    common_filters:
      - "internal_account_type = 'customer_account'"
      - "status = 'active'"

  customers_monthly_net_revenue:
    full_name: "coredata.customer.customers_monthly__net_revenue"
    purpose: "Monthly revenue metrics by customer"
    primary_key: ["customer_account_id", "report_month_date"]
    key_fields:
      - customer_account_id: "Links to customer_wide"
      - report_month_date: "Revenue reporting month"
      - net_revenue: "Total customer revenue"
      - empower_revenue: "SaaS subscription revenue"
      - cleared_gmv_amount: "Gross transaction volume"
    common_joins:
      - table: "customer_wide"
        on: "customer_account_id"
        type: "LEFT JOIN"
    date_filters:
      - l3m: "report_month_date >= DATEADD('month', -3, DATE_TRUNC('month', CURRENT_DATE)) AND report_month_date < DATE_TRUNC('month', CURRENT_DATE)"

  salesforce_opportunities:
    full_name: "coredata.salesforce.opportunities"
    purpose: "Salesforce opportunity and deal data"
    primary_key: "opportunity_id"
    key_fields:
      - opportunity_id: "Unique opportunity identifier"
      - name: "Opportunity name"
      - owner_name: "Account Executive name"
      - closed_owner_second_level_team: "Sales segment (Client Sales, MM, ENT)"
      - close_date: "Deal close date"
      - arr_deal_size: "Annual Recurring Revenue value"
      - sc_name: "Solutions Consultant name"
      - is_sc_actively_working: "SC active flag (pre-2025-07-02 logic)"
      - record_type_name: "Opportunity type (Empower for SaaS)"
      - is_won: "Won deal flag"
      - stage_name: "Deal stage"
      - salesforce_account_id: "Links to Salesforce accounts"
    common_filters:
      - "record_type_name = 'Empower'"
      - "is_won = true"
      - "closed_owner_second_level_team IN ('Client Sales','ENT','MM')"
      - "stage_name NOT IN ('DQ: Duplicate')"

  salesforce_accounts:
    full_name: "coredata.salesforce.accounts"
    purpose: "Salesforce account data"
    primary_key: "salesforce_account_id"
    key_fields:
      - salesforce_account_id: "Salesforce account ID"
      - customer_account_id: "Links to customer_wide"
      - is_primary_salesforce_account_for_cuacc: "Primary account flag"
    common_filters:
      - "is_primary_salesforce_account_for_cuacc = TRUE"

  fivetran_salesforce_account:
    full_name: "fivetran.salesforce.account"
    purpose: "Raw Salesforce account data with standard fields"
    primary_key: "id"
    key_fields:
      - id: "Salesforce account ID (links to coredata.salesforce.accounts.salesforce_account_id)"
      - name: "Account name"
      - number_of_employees: "Standard Salesforce employee count field"
      - brex_ee_count_number_c: "Custom Brex employee count field (CORRECT FIELD)"
      - brex_ee_count_c: "Custom Brex employee count field (deprecated/unpopulated)"
      - is_deleted: "Account deletion flag"
    data_quality_notes:
      employee_count_fields:
        brex_ee_count_number_c:
          coverage: "Good coverage - populated custom field"
          status: "RECOMMENDED - Use this field for Brex employee count from Salesforce"
          description: "Custom Brex field with actual employee count data"
        number_of_employees:
          coverage: "~91% (3.2M of 3.5M accounts)"
          status: "Alternative - Standard Salesforce field"
          description: "Standard Salesforce field with good data coverage"
        brex_ee_count_c:
          coverage: "0% (100% null across all accounts)"
          status: "DO NOT USE - Completely unpopulated"
          description: "Wrong custom field that was never populated"
    common_filters:
      - "is_deleted = FALSE"
    join_to_customer_data:
      description: "Requires 2-step join through coredata.salesforce.accounts"
      pattern: |
        FROM coredata.customer.customer_wide cw
        LEFT JOIN coredata.salesforce.accounts acc
            ON cw.customer_account_id = acc.customer_account_id
            AND acc.is_primary_salesforce_account_for_cuacc = TRUE
        LEFT JOIN fivetran.salesforce.account sf
            ON acc.salesforce_account_id = sf.id
            AND sf.is_deleted = FALSE

# Solutions Consultant specific tables
sc_tables:
  ae_cse_account_holding_periods:
    full_name: "salesforce.public.ae_cse_account_holding_periods"
    purpose: "SC account assignment periods"
    key_fields:
      - account_holding_period_id: "Unique period identifier"
      - customer_account_id: "Customer being served"
      - opportunity_id_determining_account_holding: "Opportunity that created assignment"
      - owner_segment_territory_role: "Territory segment"
      - account_holding_period_start_date: "Assignment start"
      - account_holding_period_end_date: "Assignment end"

  account_holding_periods_monthly:
    full_name: "salesforce.public.account_holding_periods_monthly_gmv_and_revenue"
    purpose: "Monthly commission and revenue data by holding period"
    key_fields:
      - account_holding_period_id: "Links to holding periods"
      - calendar_month: "Revenue month"
      - rep_receiving_comm_rev_credit: "Rep email getting credit"
      - rep_manager_receiving_comm_rev_credit: "Manager email"
      - commissionable_revenue: "Total commissionable revenue"
      - cse_commissionable_revenue: "CSE specific revenue"
      - saas_commissionable_revenue: "SaaS revenue component"
      - cleared_gmv_amount: "Transaction volume"

  workday_employees:
    full_name: "workday.workday.employees"
    purpose: "Employee directory for name resolution"
    key_fields:
      - email: "Employee email (join key)"
      - first_name: "First name"
      - last_name: "Last name"

# Common Join Patterns
join_patterns:
  customer_revenue_analysis:
    base_table: "coredata.customer.customer_wide"
    joins:
      - table: "coredata.customer.customers_monthly__net_revenue"
        on: "customer_account_id"
        type: "LEFT JOIN"
        additional_conditions:
          - "nrr.report_month_date >= DATEADD('month', -3, DATE_TRUNC('month', CURRENT_DATE))"
          - "nrr.report_month_date < DATE_TRUNC('month', CURRENT_DATE)"

  opportunity_customer_analysis:
    base_table: "coredata.salesforce.opportunities"
    joins:
      - table: "coredata.salesforce.accounts"
        on: "salesforce_account_id"
        type: "LEFT JOIN"
        additional_conditions:
          - "acc.is_primary_salesforce_account_for_cuacc = TRUE"
      - table: "coredata.customer.customers_monthly__net_revenue"
        on: "acc.customer_account_id = rev.customer_account_id"
        type: "LEFT JOIN"

  sc_commission_analysis:
    base_table: "salesforce.public.ae_cse_account_holding_periods"
    joins:
      - table: "salesforce.public.account_holding_periods_monthly_gmv_and_revenue"
        on: "account_holding_period_id"
        type: "LEFT JOIN"
      - table: "coredata.customer.customer_wide"
        on: "customer_account_id"
        type: "LEFT JOIN"
      - table: "coredata.salesforce.opportunities"
        on: "ahp.opportunity_id_determining_account_holding = opp.opportunity_id"
        type: "LEFT JOIN"
      - table: "workday.workday.employees"
        on: "LOWER(monthly.rep_receiving_comm_rev_credit) = LOWER(we.email)"
        type: "LEFT JOIN"

  customer_employee_count_comparison:
    base_table: "coredata.customer.customer_wide"
    joins:
      - table: "coredata.salesforce.accounts"
        on: "customer_account_id"
        type: "LEFT JOIN"
        additional_conditions:
          - "acc.is_primary_salesforce_account_for_cuacc = TRUE"
      - table: "fivetran.salesforce.account"
        on: "acc.salesforce_account_id = sf.id"
        type: "LEFT JOIN"
        additional_conditions:
          - "sf.is_deleted = FALSE"
    purpose: "Compare Brex internal employee count with Salesforce employee count data"
    recommended_fields:
      - "cw.employee_count as cw_employee_count"
      - "sf.brex_ee_count_number_c as salesforce_ee_count"
      - "cw.customer_account_id"
      - "cw.dba_name"
    data_quality_checks:
      - "CASE WHEN sf.brex_ee_count_number_c IS NULL THEN 'Missing' WHEN ABS(sf.brex_ee_count_number_c - cw.employee_count) > 50 THEN 'Large Gap' ELSE 'Aligned' END as ee_count_quality"